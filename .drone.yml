kind: pipeline
type: docker
name: build
steps:
- name: build&publish  
  image: plugins/docker
  pull: if-not-exists
  settings:
    username: 
      from_secret: dockerhub-user
    password: 
      from_secret: dockerhub-pwd
    repo: 
      from_secret: docker-repo
    tags: 
      - latest
      - v${DRONE_BUILD_NUMBER}
    dockerfile: build/Dockerfile
    context: build/
    pull_image: true
    # auto_tag: true


---
kind: pipeline
type: ssh
name: deploy

depends_on:
- build

server:
  host: 
    from_secret: ubuntuk-ssh-host
  user: 
    from_secret: ubuntuk-ssh-user
  password: 
    from_secret: ubuntuk-ssh-pwd

steps:
- name: pull&deploy
  environment:
    DPLOY_PATH:
      from_secret: dploy-path
  commands:
  - echo '*****éƒ¨ç½²docker-composeæ–‡ä»¶*****'
  - mkdir -p $${DPLOY_PATH}
  - cp docker-compose.yml $${DPLOY_PATH}
  - cd $${DPLOY_PATH}
  - pwd
  - echo '*****æ‹‰å–æœ€æ–°é•œåƒ*****'
  - docker-compose pull
  - echo '*****å¯åŠ¨ä¸­*****'
  - docker-compose up -d
  - docker-compose ps
  - echo 'BUILD SUCCESS!!!'


---
kind: pipeline
type: docker
name: notice

depends_on:
- deploy

trigger:
  status:
  - failure

steps:
- name: serverchan-notice
  image: yakumioto/drone-serverchan
  pull: if-not-exists
  settings:
    key: 
      from_secret: serverchan-key
    text: "ğŸ”¨${DRONE_REPO_NAME} ${DRONE_BUILD_STATUS}"
    desp: |
      | é¡¹ç›®åç§°     | **${DRONE_REPO_NAME}**|
      |--------------|--------------------------------------|
      | å®æ—¶çŠ¶æ€     | ![Build Status](https://drone.kamipon.com:442/api/badges/zuozhi/${DRONE_REPO_NAME}/status.svg)|
      | å½“å‰çŠ¶æ€     | **${DRONE_BUILD_STATUS}**  |
      | é¡¹ç›®åœ°å€     | [è·³è½¬åˆ°GITä»“åº“](${DRONE_REPO_LINK})  |
      | æ„å»ºæ—¥å¿—     | [è·³è½¬åˆ°DroneCI](${DRONE_BUILD_LINK}) |
      | æ„å»ºID       | ${DRONE_BUILD_NUMBER}            |
      | å½“å‰åˆ†æ”¯     | ${DRONE_COMMIT_BRANCH}           |
      | å½“å‰æäº¤ä¿¡æ¯ | ${DRONE_COMMIT_MESSAGE}           |

...